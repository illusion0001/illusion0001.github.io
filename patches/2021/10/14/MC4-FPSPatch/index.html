<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>illusion's Blog | Dynamic FPS Patch for Midnight Club: Los Angeles</title>
  
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/post.css" />
  <link rel="stylesheet" href="/assets/css/syntax.css" />
  
  <link rel="stylesheet" href="/assets/css/common.css" />
  <script src="/assets/js/categories.js"></script>
  
  <script defer src="/assets/js/lbox.js"></script>
  
  <!-- Twemoji -->
  <!-- src https://github.com/SebastianAigner/twemoji-amazing -->
  <link rel="stylesheet" href="/assets/css/twemoji-amazing.css">
</head>

  <body>
    <main class="blogfeed">
      
<header>
  <a class="site-title article-page" href="/">illusion's Blog</a>
</header>




      <section id="social-links1">
  
    <a href="/contact" target="_blank"> Contact</a>
  
    <a href="/patch" target="_blank"> Patches</a>
  
</section>

<section id="social-links">

  <a href="https://github.com/illusion0001" target="_blank">
    <img src="/assets/icons/github.svg" alt="" />
  </a>

  <a href="mailto:illusion3185@gmail.com" target="_blank">
    <img src="/assets/icons/email.svg" alt="" />
  </a>

</section>

      <section id="article">
        
        <!--  -->
        
        <!--  -->
        
        
        <div
          class="article-thumbnail"
          style="
            background-image: url('https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Thumbnail-0.jpg');
          "
        >
        
          <h1 class="article-title">Dynamic FPS Patch for Midnight Club: Los Angeles</h1>
          <div class="article-bottom">
            <small class="article-date">14 Oct 2021</small>
            <div class="article-categories">
              
              <a href="#!" class="article-category">patches</a>
              
            </div>
          </div>
        </div>
        <div class="article-content"><h1 id="intro">Intro</h1>

<p>Did you know that Midnight Club: Los Angeles on last generation of consoles run with a fixed timestep?</p>

<p>Turns out that it does. When this game started running on emulators, people quickly discovered that it ran with a fixed timestep, which means it either meets its target framerate, in this case 30 Frames Per Second or else it will either slow down or speed up. Let’s patch this so we can see what the game could look like when performance bottlenecks are eliminated in future versions of emulators.</p>

<h2 id="part-1---research">Part 1 - Research</h2>

<p>Common fixed timestep values usually are <code class="language-plaintext highlighter-rouge">1/30</code> or <code class="language-plaintext highlighter-rouge">1/60</code>, <code class="language-plaintext highlighter-rouge">0.03333333</code>, <code class="language-plaintext highlighter-rouge">0.01666667</code> for 30 and 60FPS targets. Now why is this important? Some games may used fixed timestep due to not having dynamic timestep implemented or there may be cases where logics are broken when it is not synced with the rest of the hardcoded game logics, i.e Timers, Animation timings, etc.</p>

<p>We will be searching for <code class="language-plaintext highlighter-rouge">0.03333333</code> as that is what its used in MCLA. which in hex is <code class="language-plaintext highlighter-rouge">3D088889</code> Big Endian format.</p>

<div align="center" class="">
  <a href="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen0.png">
  <img src="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen0.png" />
</a></div>

<p>A lot of results, let’s try changing one of these to our current frametime which is about <code class="language-plaintext highlighter-rouge">0.077</code> from <code class="language-plaintext highlighter-rouge">77/1000</code>.</p>

<p>It turns out it is the first result that our change has effect, which is <code class="language-plaintext highlighter-rouge">0x827D7520</code>.</p>

<p>Neat thing about the xenia emulator is that it is super easy to get executable address.</p>

<p><code class="language-plaintext highlighter-rouge">emit_source_annotations # Add extra movs and nops to make disassembly easier to read.</code></p>

<div align="center" class="">
  <a href="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen0a.png">
  <img src="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen0a.png" />
</a></div>

<div align="center">
<em>Piece of cake!</em>
</div>

<h2 id="part-2---patching">Part 2 - Patching</h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">=</span> <span class="n">fVar1</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">fVar1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dVar8</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
<span class="p">...</span>
      <span class="c1">// LAB_821bdb90</span>
      <span class="n">fVar1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">*</span> <span class="n">dVar9</span><span class="p">);</span>
      <span class="n">dVar7</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">fVar1</span><span class="p">;</span>
<span class="p">...</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">param_4</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">dVar7</span> <span class="o">+</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">fVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
</code></pre></div></div>

<p>There is a bunch of code below the if statement and I snipped most of it out, the line of interest are <code class="language-plaintext highlighter-rouge">fVar1 = (float)(min_frametime);</code> as that is where our breakpoint stopped.</p>

<p><code class="language-plaintext highlighter-rouge">821bdbb4  beq  cr6,LAB_821bdc34</code></p>

<p>This is where <code class="language-plaintext highlighter-rouge">if (param_4 != '\0')</code> goes to.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LAB_821bdc34 XREF[6]:     821bdb08(j), 821bdb68(j),
                          821bdb7c(j), 821bdb8c(j),
                          821bdbb4(j), 821bdbc4(j)
</code></pre></div></div>

<p>Looks like a lot is branching to here. If you may have noticed there is an <code class="language-plaintext highlighter-rouge">if</code> in the first code block I have already shown.</p>

<p><code class="language-plaintext highlighter-rouge">if (*(char *)(param_2 + 0x38) == '\0')</code> this also uses branching to jump to places in the code, let’s reuse that branch instruction and make it always jump with the <code class="language-plaintext highlighter-rouge">b</code> instruction. that stands for unconditional <strong>b</strong>ranch.</p>

<p><code class="language-plaintext highlighter-rouge">0x821bdb08 b Label_821bdc34</code></p>

<p>Let’s port this to the PS3 version.</p>

<p><code class="language-plaintext highlighter-rouge">3D 08 88 89 3D CC CC CD 38 D1 B7 17</code> This is the constants from the 360 version, this will become useful later on.</p>

<div align="center" class="">
  <a href="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen1.png">
  <img src="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen1.png" />
</a></div>

<div align="center">
<em>Oh no, no results</em>
</div>

<p>It turns out the mininum frametime is just slightly different. searching for just <code class="language-plaintext highlighter-rouge">3D CC CC CD 38 D1 B7 17</code> yielded one result.</p>

<div align="center" class="">
  <a href="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen0b.png">
  <img src="https://img-assets.illusion0001.workers.dev/assets/images/MC4-FPSPatch/MC4-Screen0b.png" />
</a></div>

<div align="center">
<em>Wait, this looks like a different constant</em>
</div>

<p><code class="language-plaintext highlighter-rouge">3D 08 AB 86</code>? that looks <em>strange</em>. seems to be a calcuaction error of some sort. <code class="language-plaintext highlighter-rouge">1/29.7</code> and not <code class="language-plaintext highlighter-rouge">1/30</code> it could be <code class="language-plaintext highlighter-rouge">29.97</code> but that is unlikely though, thanks to <a href="https://github.com/Whatcookie">Whatcookie</a> for pointing that out!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>004c50c0 beq cr7,Label_004c5218
LAB_004c50c4 XREF[1]:     004c5220(j)
004c50c4 lfs f0,0x1c(r3)  // breakpoint
004c5220 bne cr7,Label_004c50c4
</code></pre></div></div>

<p>The breakpoint stopped at <code class="language-plaintext highlighter-rouge">4c50c4</code> the PS3 code is a little weird, it first branches to <code class="language-plaintext highlighter-rouge">4c5218</code> then to back to after doing a compare,</p>

<p>but anyways, similar patching method can be used here. first we want to stop it from jumping all over the place by nopping out <code class="language-plaintext highlighter-rouge">bne cr7,Label_004c50c4</code> then jumping to <code class="language-plaintext highlighter-rouge">4c52c4</code>. <code class="language-plaintext highlighter-rouge">4c5240 b Label_004c52c4</code> I replaced branch at 240 because there is some code that runs after <code class="language-plaintext highlighter-rouge">bne</code>. The end result is the same.</p>

<p>Enjoy!</p>

<h1 id="results">Results</h1>

<p>Note that the video below is recorded in slow motion to show the patch at its best.</p>

<div align="center" class="responsive-video-container">
<iframe width="560" height="315" src="https://www.youtube.com/embed/4vjIctNwu8A" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</div>

<h1 id="patch">Patch</h1>

<p><a href="https://wiki.rpcs3.net/index.php?title=Midnight_Club:_Los_Angeles#Patches" class="button" role="button"><i class="fas fa-download"></i> Patch Code: RPCS3</a></p>

<p><a href="https://github.com/xenia-canary/game-patches/blob/main/patches/545407F8%20-%20Midnight%20Club%20Los%20Angeles.patch.toml" class="button" role="button"><i class="fas fa-download"></i> Patch Code: Xenia</a></p>

<h2 id="supporters">Supporters</h2>

<p>Thanks to the patrons who supported me on various platforms! You guys are awesome!</p>

<h3 id="monthly-supporters">Monthly supporters:</h3>
<ul>
  <li>
    <p><a href="https://www.patreon.com/illusion0001">Patreon</a>:</p>

    <ul>
      <li>ac2pic</li>
      <li>Alexa</li>
      <li>Brett</li>
      <li>Ciril</li>
      <li>GarnetSunset</li>
      <li>Mmmmmhno</li>
      <li>Paul</li>
      <li>PlayStation5Mods</li>
      <li>RazzySxPB</li>
      <li>Ryan</li>
      <li>Voredy</li>
      <li>YveltalGriffin</li>
      <li>Zackery</li>
      <li>alessaro92</li>
      <li>ashenC</li>
      <li>embee</li>
      <li>erdosadam24</li>
      <li>faith</li>
      <li>maplemiyazaki</li>
      <li>patrick</li>
      <li>rudi</li>
    </ul>
  </li>
  <li>
    <p><a href="https://github.com/sponsors/illusion0001">Github Sponsors</a>:</p>

    <ul>
      <li>VIPO777</li>
      <li>WardFail</li>
      <li>Whitehawkx</li>
      <li>gorshco</li>
      <li>jrson83</li>
      <li>regal.</li>
      <li>suwagawaki</li>
    </ul>
  </li>
</ul>

</div>
      </section>
      <footer>
  <p>&copy; 2021 - 2025 | illusion's Blog</br>Theme <a href="https://github.com/sharadcodes/jekyll-theme-material-you"> Jekyll Theme Material You</a></p>
</footer>

    </main>
    <section id="category-modal-bg"></section>
<section id="category-modal">
  <h1 id="category-modal-title"></h1>
  <section id="category-modal-content"></section>
</section>

  </body>
</html>
